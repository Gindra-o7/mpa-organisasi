---
import { ChevronRight } from "@lucide/astro";

export interface SubSubItem {
  name: string;
  href: string;
}

export interface SubItem {
  name: string;
  href: string;
  subSubItems?: SubSubItem[];
}

export interface MenuItem {
  name: string;
  href: string;
  subItems?: SubItem[];
}

const menuItems: MenuItem[] = [
  { name: "BERANDA", href: "/" },
  {
    name: "TENTANG KAMI",
    href: "/profil",
    subItems: [
      { name: "Profil Yayasan", href: "/profil" },
      { name: "Sambutan Ketua", href: "/profil#sambutan" },
      { name: "Visi & Misi", href: "/profil#visi-misi" },
      { name: "Sejarah Yayasan", href: "/profil#sejarah" },
    ],
  },
  {
    name: "PROGRAM",
    href: "/program",
    subItems: [
      { name: "Program Sosial", href: "/program#sosial" },
      { name: "Program Kemanusiaan", href: "/program#kemanusiaan" },
      { name: "Program Keagamaan", href: "/program#keagamaan" },
    ],
  },
  {
    name: "BERITA",
    href: "/news",
  },
  {
    name: "GALERI",
    href: "/gallery",
  }
];
---

<div class="w-full fixed top-0 left-0 z-[100] flex justify-center px-4 py-4 max-w-full transition-all duration-500 ease-in-out opacity-100" id="navbar-wrapper">
  <nav class="w-full max-w-7xl mx-auto flex justify-between items-center px-6 2xl:px-8 py-3 bg-[#388E3C]/90 backdrop-blur-md rounded-full shadow-lg border border-white/20 relative z-[100]">
    <a href="/" class="cursor-pointer hover:opacity-80 transition-opacity duration-150 active:opacity-70 flex-shrink-0">
      <span class="text-xl md:text-2xl font-bold font-sora tracking-wider">
        <span class="bg-gradient-to-r from-[#81D4FA] via-[#FFD180] to-[#FFD700] bg-clip-text text-transparent"> SAWIYAN </span>
      </span>
    </a>

    <div class="hidden xl:flex items-center gap-6 text-white font-sora font-semibold xl:text-[0.800rem]">
      {
        menuItems.map((item) => (
          <div class={`relative group ${item.subItems && "cursor-pointer"}`}>
            <a href={item.href} class={`hover:text-[#FFD180] transition-colors duration-150 ${!item.subItems && "cursor-pointer"}`}>
              {item.name}
              {item.subItems && (
                <svg class="inline w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              )}
            </a>
            {item.subItems && (
              <div class="absolute top-full left-1/2 -translate-x-1/2 w-56 bg-[#388E3C]/95 backdrop-blur-sm text-white shadow-xl rounded-lg mt-2 z-[110] border border-white/10 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 transform translate-y-2 group-hover:translate-y-0">
                <div class="py-2">
                  {item.subItems.map((subItem) => (
                    // Wrapper baru dengan 'relative' dan group/sub untuk hover bertingkat
                    <div class="relative group/sub">
                      <a href={subItem.href} class="w-full flex justify-between items-center px-4 py-2 text-white hover:bg-[#81D4FA]/20 hover:text-[#FFD180] transition-colors duration-200">
                        {subItem.name}
                        {/* Tambahkan ikon panah kanan jika ada sub-menu lagi */}
                        {subItem.subSubItems && <ChevronRight class="w-4 h-4" />}
                      </a>

                      {/* Render Dropdown Level 2 (sub-sub-item) */}
                      {subItem.subSubItems && (
                        <div class="absolute top-0 left-full w-56 bg-[#388E3C]/95 backdrop-blur-sm text-white shadow-xl rounded-lg ml-2 z-[120] border border-white/10 opacity-0 invisible group-hover/sub:opacity-100 group-hover/sub:visible transition-all duration-300">
                          <div class="py-2">
                            {subItem.subSubItems.map((subSubItem) => (
                              <a href={subSubItem.href} class="block px-4 py-2 text-white hover:bg-[#81D4FA]/20 hover:text-[#FFD180] transition-colors duration-200">
                                {subSubItem.name}
                              </a>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        ))
      }
    </div>

    <div class="xl:hidden flex gap-1 md:gap-2 justify-center items-center">
      <button id="hamburger-button" class="text-white focus:outline-none">
        <svg class="md:w-8 md:h-8 w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
        </svg>
      </button>
    </div>
  </nav>
</div>

<div id="mobile-menu" class="fixed top-0 left-0 w-full h-full bg-[#388E3C] z-[100] transform -translate-y-full transition-transform duration-300 ease-in-out xl:hidden overflow-y-auto">
  <div class="mt-[50px]">
    <div class="flex flex-col text-white text-md font-sora font-semibold">
      {
        menuItems.map((item) => (
          // REVISI: Mengubah padding dan gap
          <div class="border-b border-gray-100/30 px-7 py-4">
            {" "}
            {!item.subItems ? (
              <a href={item.href} class="block w-full hover:text-[#FFD180] transition-colors">
                {item.name}{" "}
              </a>
            ) : (
              // Accordion Level 1 (Induk)
              <div>
                {" "}
                <button class="accordion-toggle flex justify-between items-center w-full hover:text-[#FFD180] transition-colors">
                  <span>{item.name}</span>
                  <svg class="w-5 h-5 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                {/* REVISI: Panel Level 1 tidak lagi punya warna latar belakang */}{" "}
                <div class="accordion-panel py-3.5 px-4 mt-4 flex flex-col gap-3 bg-[#81D4FA]/20 rounded-lg">
                  {" "}
                  {item.subItems.map((subItem) =>
                    // INI LOGIKA BARUNYA
                    !subItem.subSubItems ? (
                      // JIKA TIDAK ADA subSubItems, render link biasa
                      <a href={subItem.href} class="block py-1 text-base font-medium text-gray-200 hover:text-white">
                        {subItem.name}
                      </a>
                    ) : (
                      // JIKA ADA, render Akordeon Level 2
                      <div>
                        <button class="accordion-toggle flex gap-3 items-center w-full py-1 text-base font-medium text-gray-200 hover:text-white">
                          <span>{subItem.name}</span>
                          <svg class="w-5 h-5 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                          </svg>
                        </button>
                        <div class="accordion-panel pl-4 py-2 mt-2 flex flex-col gap-2 bg-[#81D4FA]/30 rounded-lg">
                          {subItem.subSubItems.map((subSubItem) => (
                            <a href={subSubItem.href} class="block py-1 text-sm font-medium text-gray-300 hover:text-white">
                              {subSubItem.name}
                            </a>
                          ))}
                        </div>
                      </div>
                    )
                  )}{" "}
                </div>{" "}
              </div>
            )}{" "}
          </div>
        ))
      }
    </div>
  </div>
</div>

<script>
  const hamburgerButton = document.getElementById("hamburger-button");
  const mobileMenu = document.getElementById("mobile-menu");
  const navbarWrapper = document.getElementById("navbar-wrapper");

  // Tombol close sekarang menjadi bagian dari hamburger itu sendiri (toggle)
  hamburgerButton!.addEventListener("click", () => {
    // Cek apakah menu sedang terbuka atau tidak
    const isMenuOpen = !mobileMenu!.classList.contains("-translate-y-full");

    if (isMenuOpen) {
      mobileMenu!.classList.add("-translate-y-full");
    } else {
      mobileMenu!.classList.remove("-translate-y-full");
    }
  });

  // Logika untuk Akordeon
  const accordions = document.querySelectorAll(".accordion-toggle");
  accordions.forEach((accordion) => {
    accordion.addEventListener("click", () => {
      // Dapatkan panel sub-menu
      const panel = accordion.nextElementSibling;
      // Dapatkan ikon panah
      const icon = accordion.querySelector("svg");

      // Toggle class 'hidden' untuk expand/collapse
      panel!.classList.toggle("hidden");
      // Toggle rotasi ikon
      icon!.classList.toggle("rotate-180");
    });
  });

  // Logika untuk hide/show navbar
  let lastScrollY = window.scrollY;
  let ticking = false;
  let isMouseInTopArea = false;
  let mouseLeaveTimeout: number | null = null;
  let scrollHideTimeout: number | null = null;

  const showNavbar = () => {
    // Clear semua timeout yang ada
    if (scrollHideTimeout) {
      clearTimeout(scrollHideTimeout);
      scrollHideTimeout = null;
    }
    if (mouseLeaveTimeout) {
      clearTimeout(mouseLeaveTimeout);
      mouseLeaveTimeout = null;
    }
    navbarWrapper!.classList.remove("-translate-y-full");
    navbarWrapper!.classList.remove("opacity-0");
    navbarWrapper!.style.transform = "translateY(0)";
    navbarWrapper!.style.opacity = "1";
  };

  const hideNavbar = () => {
    navbarWrapper!.classList.add("-translate-y-full");
    navbarWrapper!.classList.add("opacity-0");
    navbarWrapper!.style.transform = "translateY(-100%)";
    navbarWrapper!.style.opacity = "0";
  };

  const scheduleHideNavbar = (delay: number = 200) => {
    // Clear timeout sebelumnya jika ada
    if (scrollHideTimeout) {
      clearTimeout(scrollHideTimeout);
    }
    // Schedule hide dengan delay
    scrollHideTimeout = window.setTimeout(() => {
      if (!isMouseInTopArea && window.scrollY >= 50) {
        hideNavbar();
      }
      scrollHideTimeout = null;
    }, delay);
  };

  const updateNavbar = () => {
    const currentScrollY = window.scrollY;

    // Jika di top (scroll position < 50px), selalu tampilkan navbar
    if (currentScrollY < 50) {
      showNavbar();
    } else {
      // Jika scroll ke bawah, schedule hide navbar dengan delay (kecuali mouse di area atas)
      if (currentScrollY > lastScrollY) {
        if (!isMouseInTopArea) {
          scheduleHideNavbar(200); // Delay 200ms sebelum hide
        }
      }
      // Jika scroll ke atas, tidak otomatis show (hanya show jika mouse di area atas atau di top)
      // Logika ini dihapus karena navbar hanya muncul di top atau saat mouse di area atas
    }

    lastScrollY = currentScrollY;
    ticking = false;
  };

  const onScroll = () => {
    if (!ticking) {
      window.requestAnimationFrame(updateNavbar);
      ticking = true;
    }
  };

  // Deteksi mouse di area atas (top 100px)
  const handleMouseMove = (e: MouseEvent) => {
    const mouseY = e.clientY;
    const topAreaThreshold = 100; // Area atas 100px

    if (mouseY <= topAreaThreshold) {
      isMouseInTopArea = true;
      // Clear timeout jika ada
      if (mouseLeaveTimeout) {
        clearTimeout(mouseLeaveTimeout);
        mouseLeaveTimeout = null;
      }
      // Tampilkan navbar jika scroll position > 50px
      if (window.scrollY >= 50) {
        showNavbar();
      }
    } else {
      // Mouse keluar dari area atas
      if (isMouseInTopArea) {
        isMouseInTopArea = false;
        // Delay hide navbar saat mouse keluar dari area atas
        if (mouseLeaveTimeout) {
          clearTimeout(mouseLeaveTimeout);
        }
        mouseLeaveTimeout = window.setTimeout(() => {
          // Hanya hide jika tidak di top dan tidak sedang scroll ke atas
          if (window.scrollY >= 50) {
            hideNavbar();
          }
          mouseLeaveTimeout = null;
        }, 300); // Delay 300ms sebelum hide
      }
    }
  };

  // Deteksi mouse enter/leave dari navbar
  const handleNavbarMouseEnter = () => {
    // Clear timeout jika ada
    if (mouseLeaveTimeout) {
      clearTimeout(mouseLeaveTimeout);
      mouseLeaveTimeout = null;
    }
    // Pastikan navbar visible saat mouse di navbar
    if (window.scrollY >= 50) {
      showNavbar();
    }
  };

  const handleNavbarMouseLeave = () => {
    // Jika mouse leave dari navbar dan tidak di top area, hide navbar setelah delay
    if (window.scrollY >= 50 && !isMouseInTopArea) {
      if (mouseLeaveTimeout) {
        clearTimeout(mouseLeaveTimeout);
      }
      mouseLeaveTimeout = window.setTimeout(() => {
        hideNavbar();
        mouseLeaveTimeout = null;
      }, 500); // Delay lebih lama saat leave dari navbar
    }
  };

  window.addEventListener("scroll", onScroll, { passive: true });
  document.addEventListener("mousemove", handleMouseMove);

  // Attach mouse events ke navbar
  navbarWrapper!.addEventListener("mouseenter", handleNavbarMouseEnter);
  navbarWrapper!.addEventListener("mouseleave", handleNavbarMouseLeave);

  // Inisialisasi: tampilkan navbar di awal jika di top
  if (window.scrollY < 50) {
    showNavbar();
  } else {
    hideNavbar();
  }
</script>
